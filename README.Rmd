---
title: "US tariffs on China"
author: "Mitsuo Shiota"
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: TRUE
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Summary

- [Chinese shares in US imports in tariff imposed goods and others in pdf](output/chinese-shares.pdf)

I have downloaded three USTR documents which list 8 digit HTS (Harmonized Tariff Scedule of the United States) codes of goods to impose tariffs on imports from China. I put those pdf files in data directory. I extract 8 digit HTS codes from them.

Next, I get data via API from [Census Bureau U.S. International Trade Data](https://www.census.gov/foreign-trade/data/), and confirm the each list is  really worth 34, 16 and 200 billion dollars respectively.

I calculate the Chinese shares on those tariff-imposed goods and on not-imposed goods, and look at the shares movements from January 2017 to now to know how much trade diversion is going.

## Libraries and functions

As usual, I attach tidyverse package. Although I don't attach, I use pdftools package to read pdf files, keyring package to input API Key, and httr package to get data from URL. Although I have found censusapi package, I don't use it, as I failed to find the arguments appropriate for the international trade data.

```{r libraries}
library(tidyverse)

```

I make functions to facilitate data transformation and acquisition.

```{r self-made functions}
# transform response list to df
res2df <- function(response) {
  res_content <- httr::content(response)
  
  df <- res_content[-1] %>% 
    unlist() %>% 
    matrix(nrow = length(res_content[-1]), byrow = TRUE) %>% 
    as_tibble(validate = NULL, .name_repair = NULL)
  
  names(df) <- unlist(res_content[[1]])
  
  df
}

# get china import data by year
import_from_china <- function(year) {
  response <- httr::GET(
    url = "https://api.census.gov/data/timeseries/intltrade/imports/hs",
    query = list(
      get="GEN_CIF_MO,I_COMMODITY",
      time=year,
      CTY_CODE="5700",
      COMM_LVL="HS10",
      key=keyring::key_get("census")
    )
  )
  
  df <- res2df(response)
  
  df$GEN_CIF_MO <- as.numeric(df$GEN_CIF_MO)
  
  df %>% 
    mutate(
      hs8 = str_sub(I_COMMODITY, end = -3L)
    ) %>% 
    select(-I_COMMODITY, -CTY_CODE, -COMM_LVL)
}

# get total import data by year
import_total <- function(year) {
  response <- httr::GET(
    url = "https://api.census.gov/data/timeseries/intltrade/imports/hs",
    query = list(
      get="GEN_CIF_MO,I_COMMODITY",
      time=year,
      COMM_LVL="HS10",
      SUMMARY_LVL2="HS",
      key=keyring::key_get("census")
    )
  )
  
  df <- res2df(response)
  
  df$GEN_CIF_MO <- as.numeric(df$GEN_CIF_MO)
  
  df %>% 
    mutate(
      hs8 = str_sub(I_COMMODITY, end = -3L)
    ) %>% 
    select(-I_COMMODITY, -SUMMARY_LVL2, -COMM_LVL)
}

```

## Extract HTS 8 digit codes from pdf files

pdftools::pdf_text lets me scan a pdf file by page. stringr package in tidyverse helps me to extract 8 digits.

Although there are small differences in the list numbers between USTR saying and my calculation, I think it is so small that I can ignore.

```{r extract_digits}
hts <- "([0-9]{4})[.]([0-9]{2})[.]([0-9]{2})"

# First tranche 34 billion dollars, 25 percent, effective on July 6, 2018
# https://ustr.gov/about-us/policy-offices/press-office/press-releases/2018/june/ustr-issues-tariffs-chinese-products
text <- pdftools::pdf_text("data/2018-13248.pdf")

tariff_list_34b <- text[5:9] %>% 
  str_extract_all(hts) %>% 
  unlist() %>% 
  str_replace_all("\\.", "")

length(tariff_list_34b) # USTR says 818

df_list_34b <- tibble(tariff = "34b", hs8 = tariff_list_34b)

# Second tranche 16 billion dollars, 25 percent, August 23, 2018
# https://ustr.gov/about-us/policy-offices/press-office/press-releases/2018/august/ustr-finalizes-second-tranche
text <- pdftools::pdf_text("data/Final Second Tranche.pdf")

tariff_list_16b <- text %>% 
  str_extract_all(hts) %>% 
  unlist() %>% 
  str_replace_all("\\.", "")

length(tariff_list_16b) # USTR says 279

df_list_16b <- tibble(tariff = "16b", hs8 = tariff_list_16b)

# 200 billion dollars, 10 percent, September 24, 2018
# https://ustr.gov/about-us/policy-offices/press-office/press-releases/2018/september/ustr-finalizes-tariffs-200
text <- pdftools::pdf_text("data/Tariff List-09.17.18.pdf")

tariff_list_200b <- text[1:(length(text) - 2)] %>% 
  str_extract_all(hts) %>% 
  unlist() %>% 
  str_replace_all("\\.", "")

length(tariff_list_200b) # USTR says 5745

df_list_200b <- tibble(tariff = "200b", hs8 = tariff_list_200b)

```

## Get international trade data, and confirm USTR claims

Following the recommendation in [Internatinal Trade Data API User Guide](https://www.census.gov/foreign-trade/reference/guides/Guide%20to%20International%20Trade%20Datasets.pdf) provided by the US Census Bureau, I register API Key. keyring package allows me to input API Key, and use it, without making it public.

```{r API_Key_input}
keyring::key_set("census")

```

I struggle with which table I should use, and reach [this page](https://www.census.gov/data/developers/data-sets/international-trade.html). Next I struggle with which variables I should use, and reach [this page](https://api.census.gov/data/timeseries/intltrade/exports/hs/variables.html). I experiment a little, and know that GEN_CIF_MO = GEN_VAL_MO + GEN_CHA_MO. Looks like CIF basis = FOB basis + Freight, insurance and other charges. I choose GEN_CIF_MO as import value.

I get to know the country code of China is 5700 from [this page](https://www.census.gov/foreign-trade/schedules/c/countryname.html).

Then I make functions above. OK, let us get data. Each download takes approximately half a minute.

```{r china_2018, warning=FALSE, cache=FALSE}
df2018 <- import_from_china(2018)

real34b <- df2018 %>% 
  semi_join(df_list_34b, by = "hs8") %>% 
  summarize(sum = sum(GEN_CIF_MO)) %>% 
  as.numeric()

real16b <- df2018 %>% 
  semi_join(df_list_16b, by = "hs8") %>% 
  summarize(sum = sum(GEN_CIF_MO)) %>% 
  as.numeric()

real200b <- df2018 %>% 
  semi_join(df_list_200b, by = "hs8") %>% 
  summarize(sum = sum(GEN_CIF_MO)) %>% 
  as.numeric()

```

Using the tariff lists of 8 digit HTS codes I extracted before, I check 2018 imports are really worth as much as 34, 16 and 200 billion dollars as USTR claims. 2018 imports are `r round(real34b/1000000000, 1)`, `r round(real16b/1000000000, 1)` and `r round(real200b/1000000000, 1)`. Ratios to the USTR claims are `r round(real34b/1000000000/34, 2)`, `r round(real16b/1000000000/16, 2)` and `r round(real200b/1000000000/200, 2)`.  Little bit smaller, but basically confirm the USTR claims.

## Look at the Chinese share movements

I get imports from China and total imports from January 2017 to now, and calculate Chinese shares in imports in each category that is 34b, 16b, 200b imposed tariffs effective on July 6, 2018, August 23, 2018, and September 24, 2018, and the rest which is not imposed tariffs.

What can I say from the chart below?

- Chinese shares are the lowest in 34b, next lowest in 16b, higher in 200b and the highest in the rest, exactly the same order of imposing tariffs. I guess USTR tends to choose lower Chinese share goods to impose tariffs to avoid supply chain distruptions.

- In both 34b and 16b, Chinese shares rise just before the effective date, and decline thereafter. In 200b, I can see the small same pattern, but see bigger rise in December 2018 just before the tariff rates were scheduled to rise from 10 to 25 percent, and bigger decline thereafter. This pattern reflects that importers rush before and flee after.

- In the tariff imposed goods, Chinese shares are declining. This means other countries' shares are rising. Trade diversion is going on.

```{r get_data, echo=FALSE, cache=FALSE, fig.width=6, fig.height=6}
# 2017
df2017 <- import_from_china(2017)

# 2019
df2019 <- import_from_china(2019)

# Combine data
df_china <- df2017 %>% 
  bind_rows(df2018) %>% 
  bind_rows(df2019)

df_china$time <- as.Date(paste0(df_china$time, "-01"), "%Y-%m-%d")

# summarize value because cutting 10 to 8 digits may have created duplication
df_china2 <- df_china %>% 
  group_by(time, hs8) %>% 
  summarize(value = sum(GEN_CIF_MO)) %>% 
  arrange(hs8, time)

# Total import
# get data, takes time
df2017t <- import_total(2017)

df2018t <- import_total(2018)

df2019t <- import_total(2019)

# combine data
df_total <- df2017t %>% 
  bind_rows(df2018t) %>% 
  bind_rows(df2019t)

df_total$time <- as.Date(paste0(df_total$time, "-01"), "%Y-%m-%d")

df_total2 <- df_total %>% 
  group_by(time, hs8) %>% 
  summarize(value = sum(GEN_CIF_MO)) %>% 
  arrange(hs8, time)

df_total2 <- df_total2 %>% 
  left_join(df_china2, by = c("hs8", "time"))

# Calculate share
df_34b <- df_total2 %>% 
  semi_join(df_list_34b, by = "hs8") %>% 
  group_by(time) %>% 
  summarize(
    total = sum(value.x),
    china = sum(value.y, na.rm = TRUE),
    share = china / total * 100
  ) %>% 
  select(time, share)

df_34b$symbol <- "34b"

df_16b <- df_total2 %>% 
  semi_join(df_list_16b, by = "hs8") %>% 
  group_by(time) %>% 
  summarize(
    total = sum(value.x),
    china = sum(value.y, na.rm = TRUE),
    share = china / total * 100
  ) %>% 
  select(time, share)

df_16b$symbol <- "16b"

df_200b <- df_total2 %>% 
  semi_join(df_list_200b, by = "hs8") %>% 
  group_by(time) %>% 
  summarize(
    total = sum(value.x),
    china = sum(value.y, na.rm = TRUE),
    share = china / total * 100
  ) %>% 
  select(time, share)

df_200b$symbol <- "200b"

df_rest <- df_total2 %>% 
  anti_join(df_list_34b, by = "hs8") %>% 
  anti_join(df_list_16b, by = "hs8") %>% 
  anti_join(df_list_200b, by = "hs8") %>% 
  group_by(time) %>% 
  summarize(
    total = sum(value.x),
    china = sum(value.y, na.rm = TRUE),
    share = china / total * 100
  ) %>% 
  select(time, share)

df_rest$symbol <- "rest"

df_all <- df_34b %>% 
  bind_rows(df_16b) %>% 
  bind_rows(df_200b) %>% 
  bind_rows(df_rest)

df_all %>% 
  ggplot(aes(x = time, y = share, color = fct_reorder2(symbol, time, share))) +
  geom_line(size = 1) +
  labs(
    title = "Chinese shares in US imports",
    x = "",
    y = "percent",
    color = "Category"
  )

ggsave(filename = "output/chinese-shares.pdf",
       width = 6, height = 6, units = "in", dpi = 300)

```

EOL
